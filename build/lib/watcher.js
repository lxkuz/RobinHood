// Generated by CoffeeScript 1.10.0
(function() {
  var Recorder, RobinHoodWatcher, Spooky, config;

  Spooky = require('spooky');

  config = require('config');

  Recorder = require('./recorder');

  RobinHoodWatcher = (function() {
    function RobinHoodWatcher(gameUrl) {
      var spooky;
      console.log("watch start " + gameUrl);
      this.gameUrl = gameUrl;
      spooky = new Spooky({
        child: {
          transport: 'http'
        },
        casper: {
          logLevel: 'debug',
          verbose: true,
          clientScripts: ["build/client/viewer.js"]
        }
      }, (function(_this) {
        return function(err) {
          var e;
          if (err) {
            e = new Error('Failed to initialize SpookyJS');
            e.details = err;
            throw e;
          }
          spooky.on('game-is-ready', Recorder.push);
          spooky.start(_this.gameUrl, function() {
            return this.wait(5000, function() {
              var data;
              console.log(this.fetchText("#robinhood-info-module"));
              data = JSON.parse(this.fetchText("#robinhood-info-module"));
              return this.emit('game-is-ready', data);
            });
          });
          spooky.run();
          spooky.on('error', function(e, stack) {
            console.error(e);
            if (stack) {
              return console.log(stack);
            }
          });
          spooky.on('console', function(line) {
            return console.log(line);
          });
          spooky.on('remote.message', function(message) {
            return console.log(message);
          });
          return spooky.on("page.error", function(msg, trace) {
            this.echo("Error:    " + msg, "ERROR");
            this.echo("file:     " + trace[0].file, "WARNING");
            this.echo("line:     " + trace[0].line, "WARNING");
            this.echo("function: " + trace[0]["function"], "WARNING");
            return errors.push(msg);
          });
        };
      })(this));
    }

    return RobinHoodWatcher;

  })();

  module.exports = RobinHoodWatcher;

}).call(this);
